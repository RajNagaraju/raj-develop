# this job is taking string inputs from user and printing
name: JSON INPUT 7 yaml

# This controls when the workflow is run. Set on to workflow
on:
  # This allows workflow to be run manually from Actions tab
  workflow_dispatch:
    # Retrieving inputs from the user
    inputs:
      SUBMIT_DATE:
        description: "Enter the submit date (YYYY-MM-DDTHH:MM:SS)"
        required: true
        default: '2024-08-19'
        type: string
      COMPONENT_VERSION:
        description: 'Enter the component/version'
        required: true
        default: 'pytorch/latest'
        type: string 
      REPO_COMMITHASH:
        description: 'Enter repo URL with commithash'
        required: true
        default: 'https://github.com/pytorch/pytorch/commit/4eee2e7a6dfbd9caab6a1e59088744ae91f2aa25'
        type: string
      ROCM_CUDA_DETAILS:
        description: "Enter details of rocm_cuda_score/rocm_cuda_score_details"
        required: true
        default: '98.44/Additional explanations: string'
        type: string
      GFX_ROCM:
        description: 'Enter gfxarch/rocm_version'
        required: true
        default: 'MI250/6.1'
        type: string
      NV_CUDA:
        description: "Enter nvarch/cuda_version"
        required: true
        default: 'A10G/12.1'
        type: string
      TTG_RAT_RS_DETAILS:
        description: "Enter details of aisw_total_test_goal/rocm_actual_testcount/rocm_score/rocm_score_details"
        required: true
        default: '359944/358763/99.67/Additional explanations: string'
      CAT_CS_DETAILS:
        description: "Enter the  cuda_actual_testcount/cuda_score/cuda_score_details"
        required: true
        default: '359149/99.77/Additinal explanation: string'
        type: string
      VERSION_DETAILS:
        description: "Enter Version Details key:value,key2:value2"
        required: true
        default: 'mkl:2024.1,python:3.8'
        type: string

# The jobs section defines jobs to run. Each job has completion status
jobs:
  # JSON Process job
  process-json:
    # Specify the runner that the job will run on
    runs-on: ubuntu-latest

    # environment variable for jobs/steps
    

    # Define the set of steps or tasks executed by the job
    steps:
      - name: clean up repo if it exists
        run: |
          cd $GITHUB_WORKSPACE
          rm -rf raj-develop
      
      - name: checkout code
        uses: actions/checkout@v4
      
      - name: checkout a unique branch
        run: echo "BRANCH_NAME=auto-json-input-${{ github.run_id }}" >> $GITHUB_ENV
      
      - name: Run Python script
        # storing user input into environment variables
        env:
          schema_version: "v4"
          submit_date: ${{ github.event.inputs.SUBMIT_DATE }}
          component_version: ${{ github.event.inputs.COMPONENT_VERSION }}
          repo_commithash: ${{ github.event.inputs.REPO_COMMITHASH }}
          ocm_cuda_details: ${{ github.event.inputs.ROCM_CUDA_DETAILS }}
          gfx_rocm: ${{ github.event.inputs.GFX_ROCM }}
          nvarch_cuda: ${{ github.event.inputs.NV_CUDA }}
          ttg_rat_rs_details: ${{ github.event.inputs.TTG_RAT_RS_DETAILS }}
          cat_cs_details: ${{ github.event.inputs.CAT_CS_DETAILS }}
          version_details: ${{ github.event.inputs.VERSION_DETAILS }}
        
        run: |
          echo "Run python script to generate json output"
          python3 $GITHUB_WORKSPACE/scripts/python/json-input.py
      
      - name: View output.json file
        run: |
          # View output.json file
          cat output.json
      - name: validate component and version 
        run: |
          #run the pytho script to verify and move the file to new location
          python3 $GITHUB_WORKSPACE/scripts/python/latest-or-stable.py
      
      - name: git config user github-actions bot
        run: |
          git config --local user.name 'github-actions[bot]'
          git config --local user.email 'github-actions[bot]@users.noreply.github.com'
      
      - name: print branch
        run: |
           mv $GITHUB_WORKSPACE/output.json $GITHUB_WORKSPACE/docker/
           git branch
      
      # Run git status
      - name: git status to show new untracked archived files
        run: git status
      
      # Find untracked files
      - name: git ls-files --others
        run: git ls-files --others --exclude-standard --full-name
      - name: git add untracked files
        run: git add `git ls-files --others --exclude-standard --full-name`
      - name: git status
        run: git status
      - name: git commit
        run: git commit -am"archive json file"
      - name: git push branch
        run: git push --set-upstream origin 
      - name: gh disable prompt
        run: |
          gh config set prompt disabled
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      - name: use gh CLI to submit PR
        run: |
          gh pr create -B main -H $BRANCH_NAME --title 'github-action PR request for creating JSON file' --body 'github-action PR request for creating JSON file'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      # Remove repo
      - name: clean up repo
        run: |
          cd $GITHUB_WORKSPACE
          rm -rf raj-develop
          

      
    
